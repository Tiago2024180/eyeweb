# ===========================================
# GitHub Actions Workflow â€” AtualizaÃ§Ã£o Semanal do Dataset
# ===========================================
# Este workflow corre automaticamente todas as segundas-feiras Ã s 03:00 UTC
# e atualiza o dataset no Hugging Face com novos dados.
#
# TambÃ©m pode ser executado manualmente atravÃ©s do GitHub UI.
#
# NOTA: Os secrets HF_TOKEN e HF_DATASET_REPO devem ser configurados em:
# GitHub â†’ Settings â†’ Secrets and variables â†’ Actions

name: ðŸ”„ Update Eye Web Dataset

on:
  # ExecuÃ§Ã£o automÃ¡tica semanal (Cron)
  schedule:
    # Todas as segundas-feiras Ã s 03:00 UTC (04:00 em Portugal no inverno)
    - cron: '0 3 * * 1'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      records:
        description: 'NÃºmero de registos a gerar (para testes)'
        required: false
        default: '10000'
        type: string

# VariÃ¡veis de ambiente globais
env:
  PYTHON_VERSION: '3.11'

jobs:
  update-dataset:
    name: ðŸ“Š Atualizar Dataset
    runs-on: ubuntu-latest
    
    # Timeout de 30 minutos (mais que suficiente)
    timeout-minutes: 30
    
    steps:
      # 1. Checkout do cÃ³digo
      - name: ðŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4
      
      # 2. Configurar Python
      - name: ðŸ Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'updater/requirements.txt'
      
      # 3. Instalar dependÃªncias
      - name: ðŸ“¦ Instalar DependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r updater/requirements.txt
      
      # 4. Executar o script de atualizaÃ§Ã£o
      - name: ðŸ”„ Executar Updater
        env:
          # Secrets configurados no GitHub Repository Settings
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
          # Sobrescrever nÃºmero de registos se fornecido manualmente
          SYNTHETIC_RECORDS: ${{ github.event.inputs.records || '10000' }}
        working-directory: ./updater
        run: |
          echo "ðŸš€ A iniciar atualizaÃ§Ã£o do dataset..."
          python updater.py
      
      # 5. (Opcional) NotificaÃ§Ã£o de sucesso
      - name: âœ… Resumo da ExecuÃ§Ã£o
        if: success()
        env:
          HF_REPO: ${{ secrets.HF_DATASET_REPO }}
        run: |
          echo "## âœ… AtualizaÃ§Ã£o ConcluÃ­da com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Data:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **RepositÃ³rio HF:** Samezinho/eye-web-breaches" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      
      # 6. (Opcional) NotificaÃ§Ã£o de falha
      - name: âŒ Log de Erro
        if: failure()
        run: |
          echo "## âŒ AtualizaÃ§Ã£o Falhou!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verificar os logs acima para mais detalhes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PossÃ­veis causas:**" >> $GITHUB_STEP_SUMMARY
          echo "- Token HF_TOKEN invÃ¡lido ou expirado" >> $GITHUB_STEP_SUMMARY
          echo "- RepositÃ³rio HF_DATASET_REPO nÃ£o existe" >> $GITHUB_STEP_SUMMARY
          echo "- Erro de rede ou timeout" >> $GITHUB_STEP_SUMMARY


# ===========================================
# INSTRUÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO
# ===========================================
#
# 1. No GitHub, vai a: Settings â†’ Secrets and variables â†’ Actions
#
# 2. Adiciona os seguintes secrets:
#    - HF_TOKEN: Token do Hugging Face com permissÃ£o WRITE
#    - HF_DATASET_REPO: Nome do repo (ex: joaosilva/eye-web-breaches)
#
# 3. (Opcional) Para testar manualmente:
#    - Vai a: Actions â†’ Update Eye Web Dataset â†’ Run workflow
#
# ===========================================
